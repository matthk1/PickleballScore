<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Pro Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn_jPqsuMWkOTM4_BshPk2kcu7K3mpYlg", 
            authDomain: "pickleballmatchup.firebaseapp.com",
            projectId: "pickleballmatchup",
            storageBucket: "pickleballmatchup.firebasestorage.app",
            messagingSenderId: "413178065158",
            appId: "1:413178065158:web:c98dbd1f80bc8dadfbae87"
        };

        const appId = firebaseConfig.appId;
        let db, auth, userId = null;
        window.appState = { players: [], schedule: [], standings: {}, isLocked: false };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; loadPlayers(); } 
                    else { signInAnonymously(auth); }
                });
            } catch (err) { console.error("Firebase Init Error:", err); }
        }

        function getPlayersRef() { return collection(db, `artifacts/${appId}/users/${userId}/pickleball_players`); }

        async function loadPlayers() {
            onSnapshot(getPlayersRef(), (snap) => {
                window.appState.players = snap.docs.map(d => ({ id: d.id, name: d.data().name }));
                renderPlayerList();
                updateMatchHint();
            });
        }

        window.updateMatchHint = function() {
            const n = window.appState.players.length;
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            const hintDiv = document.getElementById('match-hint');
            if (n < 4) { hintDiv.innerHTML = ""; return; }
            
            const fullVariety = Math.ceil((n * (n - 1)) / 4);
            let suggestCount = (courts === 1) ? Math.min(fullVariety, 15) : Math.min(fullVariety, 16);
            let pointGoal = (courts === 1) ? "7 points" : "11 points";

            hintDiv.innerHTML = `
                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mt-2 space-y-1 text-[11px]">
                    <p class="text-indigo-900 font-bold">Math Goal: ${fullVariety} matches for full variety.</p>
                    <p class="text-emerald-700 font-black italic">Recommended: ${suggestCount} matches @ ${pointGoal} (2 hours).</p>
                </div>`;
        }

window.generateSchedule = function() {
    if (window.appState.isLocked) return;
    const roundsTarget = parseInt(document.getElementById('num-matches').value) || 12;
    const playerNames = window.appState.players.map(p => p.name);
    const courts = parseInt(document.getElementById('num-courts').value) || 1;
    
    const playCounts = {};
    const waitCounts = {};
    const partnerHistory = {}; 
    const opponentHistory = {};
    const newSchedule = [];

    playerNames.forEach(n => { playCounts[n] = 0; waitCounts[n] = 0; });

    for (let r = 1; r <= 100; r++) {
        if (newSchedule.length >= roundsTarget) break;
        
        // 1. Get players based on fairness, but heavily randomized to break 'pods'
        let available = [...playerNames].sort((a,b) => 
            (waitCounts[b] - waitCounts[a]) || 
            (playCounts[a] - playCounts[b]) || 
            (Math.random() - 0.5)
        );
        
        let roundPool = available.slice(0, courts * 4);
        
        // 2. SHUFFLE the 8 players so they swap courts every round
        roundPool.sort(() => Math.random() - 0.5);
        
        let roundParticipants = [];

        for (let c = 1; c <= courts; c++) {
            if (roundPool.length < 4 || newSchedule.length >= roundsTarget) break;
            const pool = roundPool.splice(0, 4);
            
            // 3. Test all 3 possible pairings for these 4 players
            const combos = [
                { t1: [pool[0], pool[1]], t2: [pool[2], pool[3]] },
                { t1: [pool[0], pool[2]], t2: [pool[1], pool[3]] },
                { t1: [pool[0], pool[3]], t2: [pool[1], pool[2]] }
            ];

            combos.forEach(o => {
                let score = 0;
                [[o.t1[0], o.t1[1]], [o.t2[0], o.t2[1]]].forEach(pair => {
                    const key = pair.sort().join('&');
                    // MASSIVE penalty for repeat partners to force new ones
                    score += (partnerHistory[key] || 0) * 1000; 
                });
                o.t1.forEach(pA => {
                    o.t2.forEach(pB => {
                        const vs = [pA, pB].sort().join('_vs_');
                        // Moderate penalty for repeat opponents
                        score += (opponentHistory[vs] || 0) * 50; 
                    });
                });
                o.totalScore = score;
            });

            // Pick the combo with the absolute lowest history score
            const best = combos.sort((a,b) => a.totalScore - b.totalScore)[0];

            // 4. Update History
            [best.t1.sort().join('&'), best.t2.sort().join('&')].forEach(k => {
                partnerHistory[k] = (partnerHistory[k] || 0) + 1;
            });
            best.t1.forEach(pA => {
                best.t2.forEach(pB => {
                    const vs = [pA, pB].sort().join('_vs_');
                    opponentHistory[vs] = (opponentHistory[vs] || 0) + 1;
                });
            });

            [...best.t1, ...best.t2].forEach(p => { 
                playCounts[p]++; roundParticipants.push(p); waitCounts[p] = 0; 
            });

            newSchedule.push({ 
                id: `${r}-${c}`, round: r, court: c, 
                teamA: [...best.t1], teamB: [...best.t2], 
                scoreA: null, scoreB: null 
            });
        }
        playerNames.forEach(p => { if (!roundParticipants.includes(p)) waitCounts[p]++; });
    }

    window.appState.schedule = newSchedule;
    window.appState.isLocked = true;
    document.getElementById('gen-btn').disabled = true;
    document.getElementById('gen-btn').classList.add('opacity-50', 'cursor-not-allowed');
    renderSchedule();
};

        window.swapPlayer = function(matchId, playerName, fromTeam) {
            const match = window.appState.schedule.find(m => m.id === matchId);
            if (fromTeam === 'A') {
                const pB = match.teamB[0];
                match.teamA = match.teamA.map(p => p === playerName ? pB : p);
                match.teamB[0] = playerName;
            } else {
                const pA = match.teamA[0];
                match.teamB = match.teamB.map(p => p === playerName ? pA : p);
                match.teamA[0] = playerName;
            }
            renderSchedule();
            calculateStandings();
        };

        window.recordScore = function(id) {
            const m = window.appState.schedule.find(match => match.id === id);
            m.scoreA = parseInt(document.getElementById(`score-a-${id}`).value) || 0;
            m.scoreB = parseInt(document.getElementById(`score-b-${id}`).value) || 0;
            calculateStandings();
        };

        function calculateStandings() {
            const stats = {};
            window.appState.players.forEach(p => stats[p.name] = { wins: 0, losses: 0, pf: 0, pa: 0, games: 0 });
            window.appState.schedule.forEach(m => {
                if (m.scoreA !== null && m.scoreB !== null && (m.scoreA > 0 || m.scoreB > 0)) {
                    const winA = m.scoreA > m.scoreB;
                    m.teamA.forEach(p => { stats[p].games++; stats[p].pf += m.scoreA; stats[p].pa += m.scoreB; if(winA) stats[p].wins++; else stats[p].losses++; });
                    m.teamB.forEach(p => { stats[p].games++; stats[p].pf += m.scoreB; stats[p].pa += m.scoreA; if(!winA) stats[p].wins++; else stats[p].losses++; });
                }
            });
            renderStandings(stats);
        }

        function renderStandings(stats) {
            const sorted = Object.entries(stats).map(([name, d]) => ({
                name, winPct: d.games ? ((d.wins/d.games)*100).toFixed(0) : 0, diff: d.pf - d.pa, record: `${d.wins}-${d.losses}`
            })).sort((a,b) => b.winPct - a.winPct || b.diff - a.diff);
            
            document.getElementById('standings-container').innerHTML = `
                <table class="w-full text-left text-xs">
                    <tr class="text-gray-400 uppercase font-black border-b border-gray-100"><th class="pb-2">Player</th><th class="pb-2">Rec</th><th class="pb-2">Diff</th><th class="pb-2 text-right">%</th></tr>
                    ${sorted.map((p, i) => `<tr class="border-b border-gray-50 last:border-0"><td class="py-2 font-bold">${i+1}. ${p.name}</td><td>${p.record}</td><td class="font-bold ${p.diff >=0 ? 'text-emerald-600':'text-red-500'}">${p.diff > 0 ? '+'+p.diff : p.diff}</td><td class="text-right font-black text-indigo-600">${p.winPct}%</td></tr>`).join('')}
                </table>`;
        }

        function renderSchedule() {
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            const playerNames = window.appState.players.map(p => p.name);
            document.getElementById('schedule-container').innerHTML = window.appState.schedule.map(m => {
                const activeInRound = window.appState.schedule.filter(match => match.round === m.round).flatMap(match => [...match.teamA, ...match.teamB]);
                const waiting = playerNames.filter(n => !activeInRound.includes(n));
                
                const teamUI = (team, side) => team.map(p => `
                    <div class="flex items-center justify-center gap-1 font-black">
                        <span class="truncate">${p}</span>
                        <button onclick="swapPlayer('${m.id}', '${p}', '${side}')" class="text-indigo-300 hover:text-indigo-600">â‡„</button>
                    </div>`).join('');

                return `
                <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-gray-100 mb-6">
                    <div class="flex justify-between text-[10px] font-black text-gray-400 mb-3 uppercase tracking-widest">
                        <span>Round ${m.round}${courts > 1 ? ' â€¢ Ct '+m.court : ''}</span>
                        ${waiting.length && (courts === 1 || m.court === 1) ? `<span class="text-amber-600 italic">Wait: ${waiting.join(', ')}</span>` : ''}
                    </div>
                    <div class="grid grid-cols-7 items-center gap-1">
                        <div class="col-span-3 text-center text-[14px]">${teamUI(m.teamA, 'A')}</div>
                        <div class="col-span-1 flex justify-center gap-1">
                            <input type="number" id="score-a-${m.id}" value="${m.scoreA||''}" onchange="recordScore('${m.id}')" placeholder="A" class="w-8 h-8 border border-gray-200 rounded text-center font-black text-xs">
                            <input type="number" id="score-b-${m.id}" value="${m.scoreB||''}" onchange="recordScore('${m.id}')" placeholder="B" class="w-8 h-8 border border-gray-200 rounded text-center font-black text-xs">
                        </div>
                        <div class="col-span-3 text-center text-[14px]">${teamUI(m.teamB, 'B')}</div>
                    </div>
                </div>`;
            }).join('');
        }

        window.shareToWhatsApp = function() {
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            let msg = "ðŸŽ¾ *PICKLEBALL SCHEDULE*\n\n";
            window.appState.schedule.forEach(m => {
                msg += `Rnd ${m.round}${courts > 1 ? ' Ct '+m.court : ''}: ${m.teamA.join('&')} vs ${m.teamB.join('&')}\n`;
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.renderPlayerList = function() {
            document.getElementById('player-list').innerHTML = window.appState.players.map(p => `
                <div class="flex justify-between bg-gray-50 p-2 rounded mb-1 text-xs font-bold"><span>${p.name}</span><button onclick="deletePlayer('${p.id}')" class="text-red-400">âœ•</button></div>`).join('');
            document.getElementById('player-count').textContent = window.appState.players.length;
        };

        window.deletePlayer = async (id) => { await deleteDoc(doc(getPlayersRef(), id)); };
        window.addPlayer = async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-player-name');
            if (input.value.trim()) { await addDoc(getPlayersRef(), { name: input.value.trim() }); input.value = ''; }
        };
        window.confirmReset = () => { if (confirm("Reset everything?")) location.reload(); };
        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 min-h-screen pb-10 font-sans">
    <header class="bg-indigo-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-lg">
        <h1 class="font-black italic text-lg uppercase tracking-tighter">Pickleball Pro</h1>
        <div class="flex gap-2">
            <button onclick="shareToWhatsApp()" class="bg-emerald-500 text-[10px] font-black px-3 py-2 rounded-full uppercase">WhatsApp</button>
            <button onclick="confirmReset()" class="bg-white/20 text-[10px] font-bold px-3 py-2 rounded-full uppercase">Reset</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
        <div class="space-y-6">
            <div class="bg-white p-5 rounded-[2rem] shadow-sm">
                <h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">1. Players (<span id="player-count">0</span>)</h2>
                <form onsubmit="addPlayer(event)" class="flex gap-2 mb-4">
                    <input type="text" id="new-player-name" class="flex-grow bg-gray-50 rounded-xl p-3 font-bold border border-gray-100" placeholder="Name">
                    <button class="bg-indigo-600 text-white px-4 rounded-xl font-black">+</button>
                </form>
                <div id="player-list"></div>
            </div>

            <div class="bg-white p-5 rounded-[2rem] shadow-sm border-2 border-indigo-50">
                <h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">2. Setup</h2>
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase">Matches</label>
                        <input type="number" id="num-matches" value="16" class="w-full bg-gray-50 rounded-xl p-3 font-black text-indigo-600">
                    </div>
                    <div>
                        <label class="text-[9px] font-black text-gray-400 uppercase">Courts</label>
                        <select id="num-courts" onchange="updateMatchHint()" class="w-full bg-gray-50 rounded-xl p-3 font-black text-gray-700">
                            <option value="1">1 Court</option>
                            <option value="2" selected>2 Courts</option>
                        </select>
                    </div>
                </div>
                <div id="match-hint"></div>
                <button id="gen-btn" onclick="generateSchedule()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-xl uppercase text-[11px] tracking-widest mt-4 shadow-xl">Generate Schedule</button>
            </div>

            <div class="bg-white p-5 rounded-[2rem] shadow-sm">
                <h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Rankings</h2>
                <div id="standings-container"></div>
            </div>
        </div>

        <div>
            <h2 class="text-[10px] font-black text-gray-400 uppercase mb-4 tracking-widest">Live Schedule</h2>
            <div id="schedule-container"></div>
        </div>
    </main>
</body>
</html>