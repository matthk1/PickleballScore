<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Pro Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn_jPqsuMWkOTM4_BshPk2kcu7K3mpYlg", 
            authDomain: "pickleballmatchup.firebaseapp.com",
            projectId: "pickleballmatchup",
            storageBucket: "pickleballmatchup.firebasestorage.app",
            messagingSenderId: "413178065158",
            appId: "1:413178065158:web:c98dbd1f80bc8dadfbae87"
        };

        const appId = firebaseConfig.appId;
        let db, auth, userId = null;

        window.appState = { players: [], schedule: [], standings: {}, isLocked: false };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) { userId = user.uid; loadPlayers(); } 
                    else { signInAnonymously(auth); }
                });
            } catch (err) { console.error("Firebase Init Error:", err); }
        }

        function getPlayersRef() { return collection(db, `artifacts/${appId}/users/${userId}/pickleball_players`); }

        async function loadPlayers() {
            onSnapshot(getPlayersRef(), (snap) => {
                window.appState.players = snap.docs.map(d => ({ id: d.id, name: d.data().name }));
                renderPlayerList();
                updateMatchHint();
            });
        }

        window.updateMatchHint = function() {
            const n = window.appState.players.length;
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            const hintDiv = document.getElementById('match-hint');
            if (n < 4) return;
            
            const suggested = Math.ceil((n * (n - 1)) / 4);
            let contextText = "";

            if (courts === 1) {
                contextText = `<b>1-Court Logic:</b> With ${n} players, 7 will sit each round. We use a <b>Wait Queue</b> so the longest-waiting players always get the next game. Generate 20+ matches to ensure everyone gets enough play time.`;
            } else {
                contextText = `<b>2-Court Logic:</b> For ${n} players, <b>${suggested} matches</b> is the "Sweet Spot." This ensures everyone partners with almost everyone else at least once.`;
            }

            hintDiv.innerHTML = `
                <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mt-3">
                    <p class="text-[14px] text-indigo-900 leading-normal">
                        ${contextText}
                    </p>
                </div>`;
        }

        window.generateSchedule = function() {
            if (window.appState.isLocked) return;
            
            const rounds = parseInt(document.getElementById('num-matches').value) || 1;
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            const playerNames = window.appState.players.map(p => p.name);
            if (playerNames.length < 4) return alert("Need 4+ players.");

            const playCounts = playerNames.reduce((acc, n) => ({ ...acc, [n]: 0 }), {});
            const waitCounts = playerNames.reduce((acc, n) => ({ ...acc, [n]: 0 }), {});
            const partnerHistory = {};
            const newSchedule = [];

            for (let r = 1; r <= rounds; r++) {
                let roundParticipants = [];
                let available = [...playerNames].sort((a,b) => {
                    if (waitCounts[b] !== waitCounts[a]) return waitCounts[b] - waitCounts[a];
                    return playCounts[a] - playCounts[b] || Math.random() - 0.5;
                });
                
                for (let c = 1; c <= courts; c++) {
                    if (available.length < 4) break;
                    const pool = available.splice(0, 4);
                    const options = [
                        { t1: [pool[0], pool[1]], t2: [pool[2], pool[3]] },
                        { t1: [pool[0], pool[2]], t2: [pool[1], pool[3]] },
                        { t1: [pool[0], pool[3]], t2: [pool[1], pool[2]] }
                    ];
                    options.forEach(o => {
                        const p1 = o.t1.sort().join('&');
                        const p2 = o.t2.sort().join('&');
                        o.score = (partnerHistory[p1] || 0) + (partnerHistory[p2] || 0);
                    });
                    const best = options.sort((a,b) => a.score - b.score)[0];
                    partnerHistory[best.t1.sort().join('&')] = (partnerHistory[best.t1.sort().join('&')] || 0) + 1;
                    partnerHistory[best.t2.sort().join('&')] = (partnerHistory[best.t2.sort().join('&')] || 0) + 1;
                    [...best.t1, ...best.t2].forEach(p => { playCounts[p]++; roundParticipants.push(p); waitCounts[p] = 0; });
                    newSchedule.push({ id: `${r}-${c}`, round: r, court: c, teamA: best.t1, teamB: best.t2, scoreA: null, scoreB: null });
                }
                playerNames.forEach(p => { if (!roundParticipants.includes(p)) waitCounts[p]++; });
            }
            window.appState.schedule = newSchedule;
            window.appState.isLocked = true;
            document.getElementById('gen-btn').disabled = true;
            document.getElementById('gen-btn').classList.add('opacity-50', 'cursor-not-allowed');
            renderSchedule();
            calculateStandings();
        };

        window.confirmReset = function() {
            if (confirm("‚ö†Ô∏è RESET SESSION?\n\nThis will wipe all scores and the current schedule. Do you want to proceed?")) {
                location.reload();
            }
        };

        window.recordScore = function(id) {
            const m = window.appState.schedule.find(match => match.id === id);
            m.scoreA = parseInt(document.getElementById(`score-a-${id}`).value) || 0;
            m.scoreB = parseInt(document.getElementById(`score-b-${id}`).value) || 0;
            calculateStandings();
        };

        function calculateStandings() {
            const stats = {};
            window.appState.players.forEach(p => stats[p.name] = { wins: 0, losses: 0, pf: 0, pa: 0, games: 0 });
            window.appState.schedule.forEach(m => {
                if (m.scoreA !== null && m.scoreB !== null && (m.scoreA > 0 || m.scoreB > 0)) {
                    const winA = m.scoreA > m.scoreB;
                    m.teamA.forEach(p => { stats[p].games++; stats[p].pf += m.scoreA; stats[p].pa += m.scoreB; if(winA) stats[p].wins++; else stats[p].losses++; });
                    m.teamB.forEach(p => { stats[p].games++; stats[p].pf += m.scoreB; stats[p].pa += m.scoreA; if(!winA) stats[p].wins++; else stats[p].losses++; });
                }
            });
            renderStandings(stats);
        }

        function renderPlayerList() {
            document.getElementById('player-list').innerHTML = window.appState.players.map(p => `
                <div class="flex justify-between items-center bg-gray-50 p-4 rounded-2xl mb-2 border border-gray-100"><span class="text-xl font-bold text-gray-700">${p.name}</span><button onclick="deletePlayer('${p.id}')" class="text-red-400 px-2 text-2xl font-light">‚úï</button></div>`).join('');
            document.getElementById('player-count').textContent = window.appState.players.length;
        }

        function renderSchedule() {
            const playerNames = window.appState.players.map(p => p.name);
            document.getElementById('schedule-container').innerHTML = window.appState.schedule.map(m => {
                const active = window.appState.schedule.filter(match => match.round === m.round).flatMap(match => [...match.teamA, ...match.teamB]);
                const out = playerNames.filter(n => !active.includes(n));
                return `
                <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 mb-6">
                    <div class="flex justify-between text-xs font-black text-gray-400 mb-4 uppercase tracking-widest">
                        <span>Round ${m.round} ‚Ä¢ Court ${m.court}</span>
                        ${out.length ? `<span class="bg-amber-50 text-amber-700 px-3 py-1 rounded-full italic font-bold">Waiting: ${out.join(', ')}</span>` : ''}
                    </div>
                    <div class="grid grid-cols-7 items-center gap-4">
                        <div class="col-span-3 text-center text-2xl font-black text-gray-800 leading-tight">${m.teamA.join('<br>& ')}</div>
                        <div class="col-span-1 flex flex-col gap-2 items-center">
                            <input type="number" id="score-a-${m.id}" onchange="recordScore('${m.id}')" class="w-16 h-14 border-2 border-indigo-100 rounded-2xl text-center text-indigo-700 font-black text-2xl outline-none focus:ring-2 focus:ring-indigo-400">
                            <input type="number" id="score-b-${m.id}" onchange="recordScore('${m.id}')" class="w-16 h-14 border-2 border-emerald-100 rounded-2xl text-center text-emerald-700 font-black text-2xl outline-none focus:ring-2 focus:ring-emerald-400">
                        </div>
                        <div class="col-span-3 text-center text-2xl font-black text-gray-800 leading-tight">${m.teamB.join('<br>& ')}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStandings(stats) {
            const sorted = Object.entries(stats).map(([name, d]) => {
                const winPct = d.games ? ((d.wins/d.games)*100).toFixed(0) : 0;
                const avgDiff = d.games ? ((d.pf - d.pa) / d.games).toFixed(1) : "0.0";
                return { name, winPct, avgDiff, record: `${d.wins}-${d.losses}` };
            }).sort((a,b) => b.winPct - a.winPct || b.avgDiff - a.avgDiff);

            document.getElementById('standings-container').innerHTML = sorted.map((p, i) => `
                <div class="flex justify-between items-center py-5 border-b border-gray-50 last:border-0">
                    <div class="flex flex-col">
                        <span class="text-2xl font-black text-gray-800">${i+1}. ${p.name}</span>
                        <span class="text-sm text-gray-400 uppercase font-bold tracking-wider mt-1">${p.record} | Avg Diff: ${p.avgDiff > 0 ? '+' : ''}${p.avgDiff}</span>
                    </div>
                    <span class="font-black text-indigo-600 text-3xl">${p.winPct}%</span>
                </div>`).join('');
        }

        window.shareToWhatsApp = function() {
            if (window.appState.schedule.length === 0) return alert("Generate matches first!");
            let msg = "üéæ *PICKLEBALL MATCH SCHEDULE*\n\n";
            const rounds = [...new Set(window.appState.schedule.map(m => m.round))];
            rounds.forEach(r => {
                msg += `*ROUND ${r}*\n`;
                window.appState.schedule.filter(m => m.round === r).forEach(m => {
                    msg += `Ct ${m.court}: ${m.teamA.join('&')} vs ${m.teamB.join('&')}\n`;
                });
                msg += "\n";
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.deletePlayer = async (id) => { await deleteDoc(doc(getPlayersRef(), id)); };
        window.addPlayer = async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-player-name');
            if (input.value.trim()) { await addDoc(getPlayersRef(), { name: input.value.trim() }); input.value = ''; }
        };

        window.onload = initFirebase;
    </script>
</head>
<body class="bg-gray-100 min-h-screen pb-20 font-sans text-gray-900">
    <header class="bg-indigo-900 text-white p-7 shadow-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="font-black italic text-3xl tracking-tighter uppercase">Pickleball Pro</h1>
            <div class="flex gap-4">
                <button onclick="shareToWhatsApp()" class="bg-emerald-500 text-[12px] font-black px-7 py-4 rounded-full uppercase shadow-lg active:scale-95 transition-all">WhatsApp</button>
                <button onclick="confirmReset()" class="bg-white/20 text-white text-[12px] font-bold px-7 py-4 rounded-full uppercase transition-all hover:bg-red-600">Reset Session</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-8 mt-6">
        <div class="lg:col-span-4 space-y-6">
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-gray-200">
                <h2 class="text-xs font-black text-gray-400 uppercase mb-6 tracking-widest">1. Players (<span id="player-count">0</span>)</h2>
                <form onsubmit="addPlayer(event)" class="flex gap-3 mb-6">
                    <input type="text" id="new-player-name" class="flex-grow bg-gray-50 rounded-2xl p-6 text-xl font-bold outline-none border border-gray-100 focus:ring-2 focus:ring-indigo-500" placeholder="Add Player">
                    <button class="bg-indigo-600 text-white px-9 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition text-2xl">+</button>
                </form>
                <div id="player-list"></div>
            </div>

            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-gray-200">
                <h2 class="text-xs font-black text-gray-400 uppercase mb-6 tracking-widest">2. Match Setup</h2>
                <div class="space-y-6">
                    <div>
                        <label class="text-[12px] font-black text-gray-500 uppercase tracking-widest ml-1">Number of Matches</label>
                        <input type="number" id="num-matches" value="12" class="w-full bg-gray-50 rounded-2xl p-6 text-3xl font-black text-indigo-600 outline-none border border-gray-100 mt-2">
                    </div>
                    <div>
                        <label class="text-[12px] font-black text-gray-500 uppercase tracking-widest ml-1">Courts</label>
                        <select id="num-courts" onchange="updateMatchHint()" class="w-full bg-gray-50 rounded-2xl p-6 text-xl font-black text-gray-700 outline-none border border-gray-100 mt-2">
                            <option value="1">1 Court</option>
                            <option value="2" selected>2 Courts</option>
                        </select>
                        <div id="match-hint"></div>
                    </div>
                    <button id="gen-btn" onclick="generateSchedule()" class="w-full bg-indigo-600 text-white font-black py-7 rounded-2xl uppercase text-lg tracking-widest shadow-xl hover:bg-indigo-700 transition-all active:scale-95">Generate Schedule</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-5">
            <h2 class="text-xs font-black text-gray-400 uppercase mb-6 tracking-widest ml-1 italic">3. Live Schedule</h2>
            <div id="schedule-container"></div>
        </div>

        <div class="lg:col-span-3">
            <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-gray-200 sticky top-40">
                <h2 class="text-xs font-black text-gray-400 uppercase mb-6 tracking-widest border-b pb-4 italic">Rankings</h2>
                <div id="standings-container"></div>
                <div class="mt-8 bg-indigo-50 p-7 rounded-[2rem] border border-indigo-100">
                    <p class="text-[14px] text-indigo-800 leading-relaxed font-bold italic">
                        üèÜ Ranked by Win Rate. Avg Diff is used as a tie-breaker.
                    </p>
                </div>
            </div>
        </div>
    </main>
</body>
</html>