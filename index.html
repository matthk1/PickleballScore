<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pickleball Doubles Scheduler </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCn_jPqsuMWkOTM4_BshPk2kcu7K3mpYlg", 
            authDomain: "pickleballmatchup.firebaseapp.com",
            projectId: "pickleballmatchup",
            storageBucket: "pickleballmatchup.firebasestorage.app",
            messagingSenderId: "413178065158",
            appId: "1:413178065158:web:c98dbd1f80bc8dadfbae87"
        };

        const appId = firebaseConfig.appId;
        let db, auth, userId = null;

        window.appState = {
            players: [],
            schedule: [],
            standings: {}
        };

        // --- FIREBASE INIT ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        loadPlayers();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (err) { console.error("Firebase Error:", err); }
        }

        function getPlayersRef() { return collection(db, `artifacts/${appId}/users/${userId}/pickleball_players`); }

        async function loadPlayers() {
            onSnapshot(getPlayersRef(), (snap) => {
                window.appState.players = snap.docs.map(d => ({ id: d.id, name: d.data().name }));
                renderPlayerList();
            });
        }

        // --- SCHEDULING (FAIRNESS & VARIETY) ---
        window.generateSchedule = function() {
            const rounds = parseInt(document.getElementById('num-matches').value) || 1;
            const courts = parseInt(document.getElementById('num-courts').value) || 1;
            const playersNeeded = courts * 4;
            const playerNames = window.appState.players.map(p => p.name);

            if (playerNames.length < playersNeeded) {
                alert(`Need at least ${playersNeeded} players.`);
                return;
            }

            const localPlayCounts = playerNames.reduce((acc, n) => ({ ...acc, [n]: 0 }), {});
            const localPartnerHistory = {};
            const localOpponentHistory = {};
            const newSchedule = [];

            for (let r = 1; r <= rounds; r++) {
                let available = [...playerNames].sort((a,b) => 
                    localPlayCounts[a] - localPlayCounts[b] || Math.random() - 0.5
                );
                
                for (let c = 1; c <= courts; c++) {
                    const pool = available.splice(0, 4);
                    const options = [
                        { t1: [pool[0], pool[1]], t2: [pool[2], pool[3]] },
                        { t1: [pool[0], pool[2]], t2: [pool[1], pool[3]] },
                        { t1: [pool[0], pool[3]], t2: [pool[1], pool[2]] }
                    ];

                    options.forEach(opt => {
                        const p1 = opt.t1.sort().join('&');
                        const p2 = opt.t2.sort().join('&');
                        const opponents = [
                            [opt.t1[0], opt.t2[0]].sort().join('vs'),
                            [opt.t1[0], opt.t2[1]].sort().join('vs'),
                            [opt.t1[1], opt.t2[0]].sort().join('vs'),
                            [opt.t1[1], opt.t2[1]].sort().join('vs')
                        ];
                        const pScore = (localPartnerHistory[p1] || 0) + (localPartnerHistory[p2] || 0);
                        const oScore = opponents.reduce((sum, pair) => sum + (localOpponentHistory[pair] || 0), 0);
                        opt.conflict = (pScore * 3) + oScore;
                    });

                    const best = options.sort((a, b) => a.conflict - b.conflict)[0];

                    localPartnerHistory[best.t1.sort().join('&')] = (localPartnerHistory[best.t1.sort().join('&')] || 0) + 1;
                    localPartnerHistory[best.t2.sort().join('&')] = (localPartnerHistory[best.t2.sort().join('&')] || 0) + 1;
                    best.t1.forEach(pA => best.t2.forEach(pB => {
                        const k = [pA, pB].sort().join('vs');
                        localOpponentHistory[k] = (localOpponentHistory[k] || 0) + 1;
                    }));
                    [...best.t1, ...best.t2].forEach(p => localPlayCounts[p]++);

                    newSchedule.push({
                        id: `${r}-${c}`, round: r, court: c,
                        teamA: best.t1, teamB: best.t2,
                        scoreA: null, scoreB: null
                    });
                }
            }
            window.appState.schedule = newSchedule;
            renderSchedule();
            calculateStandings();
        };

        // --- WIN/LOSS CALCULATIONS ---
        window.recordScore = function(id) {
            const m = window.appState.schedule.find(match => match.id === id);
            m.scoreA = parseInt(document.getElementById(`score-a-${id}`).value) || 0;
            m.scoreB = parseInt(document.getElementById(`score-b-${id}`).value) || 0;
            calculateStandings();
        };

        function calculateStandings() {
            const stats = {};
            window.appState.players.forEach(p => stats[p.name] = { wins: 0, losses: 0, pf: 0, pa: 0, games: 0 });

            window.appState.schedule.forEach(m => {
                if (m.scoreA !== null && m.scoreB !== null && (m.scoreA > 0 || m.scoreB > 0)) {
                    const teamAWins = m.scoreA > m.scoreB;
                    const teamBWins = m.scoreB > m.scoreA;

                    m.teamA.forEach(p => {
                        if(stats[p]) {
                            stats[p].games++; stats[p].pf += m.scoreA; stats[p].pa += m.scoreB;
                            if(teamAWins) stats[p].wins++; if(teamBWins) stats[p].losses++;
                        }
                    });
                    m.teamB.forEach(p => {
                        if(stats[p]) {
                            stats[p].games++; stats[p].pf += m.scoreB; stats[p].pa += m.scoreA;
                            if(teamBWins) stats[p].wins++; if(teamAWins) stats[p].losses++;
                        }
                    });
                }
            });
            renderStandings(stats);
        }

        // --- BUTTON ACTIONS ---
        window.shareToWhatsApp = function() {
            if (window.appState.schedule.length === 0) return alert("Generate matches first!");
            const playerNames = window.appState.players.map(p => p.name);
            let msg = "ðŸŽ¾ *PICKLEBALL MATCHES*\n\n";
            const rounds = [...new Set(window.appState.schedule.map(m => m.round))];
            
            rounds.forEach(r => {
                msg += `*ROUND ${r}*\n`;
                const rMatches = window.appState.schedule.filter(m => m.round === r);
                rMatches.forEach(m => msg += `Ct ${m.court}: ${m.teamA.join('&')} vs ${m.teamB.join('&')}\n`);
                const active = rMatches.flatMap(m => [...m.teamA, ...m.teamB]);
                const out = playerNames.filter(n => !active.includes(n));
                if (out.length) msg += `_Sitting: ${out.join(', ')}_\n`;
                msg += "\n";
            });
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.resetSession = function() {
            if(confirm("Reset all games?")) {
                window.appState.schedule = [];
                renderSchedule();
                renderStandings({});
            }
        };

        // --- RENDERING ---
        function renderPlayerList() {
            document.getElementById('player-list').innerHTML = window.appState.players.map(p => `
                <div class="flex justify-between items-center bg-white p-2 rounded-xl border mb-2">
                    <span class="text-sm font-semibold text-slate-700">${p.name}</span>
                    <button onclick="deletePlayer('${p.id}')" class="text-red-300 hover:text-red-500">âœ•</button>
                </div>
            `).join('');
            document.getElementById('player-count').textContent = window.appState.players.length;
        }

        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            const playerNames = window.appState.players.map(p => p.name);
            if (!window.appState.schedule.length) { 
                container.innerHTML = "<div class='bg-white p-10 rounded-3xl border-2 border-dashed border-slate-200 text-center text-slate-400'>Generate a schedule to begin</div>"; 
                return; 
            }

            container.innerHTML = window.appState.schedule.map(m => {
                const active = window.appState.schedule.filter(match => match.round === m.round).flatMap(match => [...match.teamA, ...match.teamB]);
                const out = playerNames.filter(n => !active.includes(n));
                return `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-black text-slate-300 uppercase tracking-widest">Round ${m.round} â€¢ Court ${m.court}</span>
                        ${m.court === 1 ? `<span class="text-[9px] bg-amber-50 text-amber-600 px-3 py-1 rounded-full font-bold uppercase">Sitting: ${out.join(', ')}</span>` : ''}
                    </div>
                    <div class="grid grid-cols-7 items-center">
                        <div class="col-span-3 text-center">
                            <p class="text-xs font-black text-slate-800">${m.teamA.join('<br>& ')}</p>
                            <input type="number" id="score-a-${m.id}" value="${m.scoreA||''}" onchange="recordScore('${m.id}')" class="w-14 border-2 border-slate-50 rounded-xl mt-2 text-center font-black text-indigo-600 h-10 outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="col-span-1 text-center font-black text-slate-200 text-[10px] italic">VS</div>
                        <div class="col-span-3 text-center">
                            <p class="text-xs font-black text-slate-800">${m.teamB.join('<br>& ')}</p>
                            <input type="number" id="score-b-${m.id}" value="${m.scoreB||''}" onchange="recordScore('${m.id}')" class="w-14 border-2 border-slate-50 rounded-xl mt-2 text-center font-black text-emerald-600 h-10 outline-none focus:ring-2 focus:ring-emerald-500">
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStandings(stats) {
            const sorted = Object.entries(stats).map(([name, d]) => ({ 
                name, 
                winPct: d.games ? ((d.wins / d.games) * 100).toFixed(0) : 0,
                diff: d.pf - d.pa,
                record: `${d.wins}-${d.losses}`
            })).sort((a,b) => b.winPct - a.winPct || b.diff - a.diff);
            
            document.getElementById('standings-container').innerHTML = sorted.map((p, i) => `
                <div class="flex justify-between items-center py-3 border-b border-slate-50 last:border-0">
                    <div class="flex flex-col">
                        <span class="text-sm font-black ${i===0?'text-indigo-600':'text-slate-700'}">${i+1}. ${p.name}</span>
                        <span class="text-[9px] text-slate-400 font-bold uppercase">${p.record} (Diff: ${p.diff > 0 ? '+' : ''}${p.diff})</span>
                    </div>
                    <div class="text-right">
                        <span class="block font-black text-slate-800 leading-none">${p.winPct}%</span>
                        <span class="text-[8px] text-slate-300 uppercase font-black">Win Rate</span>
                    </div>
                </div>
            `).join('');
        }

        window.deletePlayer = async (id) => { await deleteDoc(doc(getPlayersRef(), id)); };
        window.addPlayer = async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-player-name');
            if (input.value.trim()) { await addDoc(getPlayersRef(), { name: input.value.trim() }); input.value = ''; }
        };

        window.onload = initFirebase;
    </script>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans pb-20">
    <header class="bg-white border-b border-slate-200 p-4 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <h1 class="font-black italic text-indigo-600 tracking-tighter text-xl">PICKLEBALL DOUBLES SCHEDULER</h1>
            <div class="flex gap-2">
                <button onclick="shareToWhatsApp()" class="bg-emerald-500 hover:bg-emerald-600 text-white text-[10px] font-black px-5 py-2.5 rounded-full uppercase tracking-widest shadow-lg shadow-emerald-50 transition-all">WhatsApp</button>
                <button onclick="resetSession()" class="bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 text-[10px] font-black px-5 py-2.5 rounded-full uppercase tracking-widest transition-all">Reset</button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 mt-8 grid grid-cols-1 md:grid-cols-12 gap-8">
        <div class="md:col-span-4 space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Players (<span id="player-count">0</span>)</h3>
                <form onsubmit="addPlayer(event)" class="flex gap-2 mb-6">
                    <input type="text" id="new-player-name" class="flex-grow bg-slate-50 border-none rounded-2xl p-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Name...">
                    <button class="bg-indigo-600 text-white px-5 rounded-2xl font-black shadow-lg shadow-indigo-50 hover:scale-105 transition-transform">+</button>
                </form>
                <div id="player-list"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Settings</h3>
                <div class="space-y-4">
                    <input type="number" id="num-matches" value="6" class="w-full bg-slate-50 border-none rounded-2xl p-3 text-sm font-black text-indigo-600" placeholder="Rounds">
                    <select id="num-courts" class="w-full bg-slate-50 border-none rounded-2xl p-3 text-sm font-black text-slate-700">
                        <option value="1">1 Court</option>
                        <option value="2" selected>2 Courts</option>
                    </select>
                    <button onclick="generateSchedule()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl uppercase text-xs tracking-widest shadow-xl shadow-indigo-100 transition-all">Generate Games</button>
                </div>
            </div>
        </div>

        <div class="md:col-span-5">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 ml-1">Today's Games</h3>
            <div id="schedule-container"></div>
        </div>

        <div class="md:col-span-3">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 sticky top-24">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 border-b pb-2 italic">Individual Rankings</h3>
                <div id="standings-container"></div>
                <div class="mt-6 pt-4 border-t border-slate-50 text-[9px] text-slate-300 italic">
                    Ranked by Win % then Point Differential. Fair for rotation play.
                </div>
            </div>
        </div>
    </main>
</body>
</html>