import{initializeApp as k}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";import{getAuth as D,onAuthStateChanged as H,signInAnonymously as N}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";import{setLogLevel as O,getFirestore as F,addDoc as W,deleteDoc as _,doc as q,onSnapshot as z,collection as G}from"https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))s(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}})();O("debug");const x={apiKey:"AIzaSyCn_jPqsuMWkOTM4_BshPk2kcu7K3mpYlg",authDomain:"pickleballmatchup.firebaseapp.com",projectId:"pickleballmatchup",storageBucket:"pickleballmatchup.firebasestorage.app",messagingSenderId:"413178065158",appId:"1:413178065158:web:c98dbd1f80bc8dadfbae87",measurementId:"G-DZ588D1T59"},R=x.appId;let $,b,h=null,w=!1;window.appState={players:[],numMatches:1,schedule:[],standings:{},loading:!0,error:null};async function V(){try{if(Object.keys(x).length===0)throw new Error("Firebase configuration is missing.");const e=k(x);$=F(e),b=D(e),H(b,r=>{r?(h=r.uid,w=!0,document.getElementById("user-id").textContent=h,K()):(N(b),h=null,w=!0,document.getElementById("user-id").textContent="Anonymous (reloading)")})}catch(e){console.error("Firebase Initialization Error:",e),document.getElementById("status-message").textContent=`Initialization Error: ${e.message}`}}function S(){if(!h)throw new Error("User not authenticated.");return G($,`artifacts/${R}/users/${h}/pickleball_players`)}async function K(){if(!(!w||!h))try{z(S(),e=>{const r=[];e.forEach(n=>{r.push({id:n.id,name:n.data().name})}),window.appState.players=r,Z(),window.appState.loading=!1,document.getElementById("status-message").textContent=""},e=>{console.error("Error loading players:",e),document.getElementById("status-message").textContent=`Data Load Error: ${e.message}`})}catch(e){console.error("Error setting up player listener:",e),window.appState.error=e.message}}async function U(e){if(!w||!h){appState.error="Authentication not ready. Cannot save.",p();return}if(window.appState.players.some(r=>r.name.toLowerCase()===e.toLowerCase())){appState.error="Player with this name already exists.",p();return}try{await W(S(),{name:e.trim()})}catch(r){console.error("Error saving player:",r),appState.error=`Could not save player: ${r.message}`,p()}}async function I(e){if(!(!w||!h))try{await _(q(S(),e))}catch(r){console.error("Error deleting player:",r),appState.error=`Could not delete player: ${r.message}`,p()}}function Y(e,r){const n={};return r.forEach(s=>{n[s]={},r.forEach(t=>{s!==t&&(n[s][t]=0)})}),e.forEach(s=>{if(s.teamA.length===2){const[t,o]=s.teamA.sort();n[t][o]++,n[o][t]++}if(s.teamB.length===2){const[t,o]=s.teamB.sort();n[t][o]++,n[o][t]++}}),n}window.generateSchedule=function(){const e=parseInt(document.getElementById("num-matches").value,10)||1;window.appState.numMatches=e;const{players:r}=window.appState,n=r.map(o=>o.name);if(n.length<4){window.appState.error="You need at least 4 players to schedule a doubles match.",p();return}const s=n.reduce((o,a)=>({...o,[a]:0}),{}),t=[];for(let o=0;o<e;o++){let a=[...n].sort((l,d)=>{const f=s[l],y=s[d];return f!==y?f-y:l.localeCompare(d)});if(a.length<4)break;const c=a.slice(0,4),u=Y(t,n),i=c,g=[{pairA:[i[0],i[1]],pairB:[i[2],i[3]]},{pairA:[i[0],i[2]],pairB:[i[1],i[3]]},{pairA:[i[0],i[3]],pairB:[i[1],i[2]]}].map(l=>{const d=[l.pairA[0],l.pairA[1]].sort(),f=[l.pairB[0],l.pairB[1]].sort(),y=u[d[0]][d[1]],A=u[f[0]][f[1]],T=Math.max(y,A),j=y+A;return{...l,maxPartnershipCount:T,totalPartnershipCount:j}});g.sort((l,d)=>l.maxPartnershipCount!==d.maxPartnershipCount?l.maxPartnershipCount-d.maxPartnershipCount:l.totalPartnershipCount!==d.totalPartnershipCount?l.totalPartnershipCount-d.totalPartnershipCount:l.pairA[0].localeCompare(d.pairA[0]));const v=g[0],B=v.pairA,E=v.pairB;[...B,...E].forEach(l=>s[l]++),t.push({matchId:o+1,teamA:B,teamB:E,scoreA:null,scoreB:null})}window.appState.schedule=t,window.appState.standings={},window.appState.error=null,M(),calculateWinner()};window.recordScore=function(e){const r=e-1,n=window.appState.schedule[r];if(!n)return;const s=document.getElementById(`score-a-${e}`).value,t=document.getElementById(`score-b-${e}`).value,o=parseInt(s,10),a=parseInt(t,10);if(isNaN(o)||isNaN(a)||o<0||a<0){window.appState.error="Scores must be non-negative numbers.",p();return}n.scoreA=o,n.scoreB=a,P(n),calculateWinner()};window.calculateWinner=function(){const e={},{players:r,schedule:n}=window.appState;r.map(t=>t.name).forEach(t=>{e[t]={score:0,matches:0,average:0}}),n.forEach(t=>{const{teamA:o,teamB:a,scoreA:c,scoreB:u}=t;if(c!==null&&u!==null){const i=(m,g)=>{e.hasOwnProperty(m)?(e[m].score+=g,e[m].matches+=1):e[m]={score:g,matches:1,average:0}};o.forEach(m=>{i(m,c)}),a.forEach(m=>{i(m,u)})}}),Object.keys(e).forEach(t=>{const o=e[t];o.matches>0&&(o.average=o.score/o.matches)}),window.appState.standings=e,L()};window.shareSchedule=async function(){const{schedule:e}=window.appState;if(e.length===0){window.appState.error="Generate a schedule first to share it.",p();return}const n=`--- Pickleball Match Schedule ---

${e.map(t=>{const o=t.teamA.join(" & "),a=t.teamB.join(" & ");let c="";return t.scoreA!==null&&t.scoreB!==null&&(c=` (${t.scoreA} - ${t.scoreB})`),`Match ${t.matchId}: ${o} vs ${a}${c}`}).join(`
`)}

Generated by the Pickleball Doubles Scheduler.`,s=document.getElementById("share-status");if(s.textContent="",navigator.share)try{await navigator.share({title:"Pickleball Match Schedule",text:n})}catch(t){t.name!=="AbortError"&&(console.error("Error sharing:",t),window.appState.error="Could not share schedule.",p())}else try{await navigator.clipboard.writeText(n),s.textContent="Schedule copied to clipboard! Share it with your friends.",setTimeout(()=>s.textContent="",4e3)}catch(t){console.error("Failed to copy text:",t),window.appState.error="Sharing not supported. Failed to copy to clipboard.",p()}};function p(){const e=document.getElementById("error-message");window.appState.error&&(e.classList.remove("hidden"),e.textContent=`Error: ${window.appState.error}`,setTimeout(()=>{window.appState.error=null,e.classList.add("hidden")},5e3))}function C(){const e=window.appState.players.length,r=document.getElementById("match-hint");if(e<4)r.innerHTML='<p class="text-red-500 font-medium mt-1">Need 4 or more players to generate a match.</p>';else{const n=Math.ceil(e*(e-1)/4);r.innerHTML=`
                    <p class="text-sm text-gray-600 mt-2">
                        Recommendation for maximum partner variety: 
                        <span class="font-bold text-indigo-700">${n}</span> matches (or more) 
                        is typically needed for each player to partner with all ${e-1} others once.
                    </p>
                `}}function Z(){const e=document.getElementById("player-list");e.innerHTML="",document.getElementById("player-count").textContent=window.appState.players.length,window.appState.players.length===0&&(e.innerHTML='<p class="text-gray-500 italic">No players added yet. Add players above to save them for the next time.</p>'),window.appState.players.forEach(r=>{const n=document.createElement("div");n.className="flex items-center justify-between p-2 bg-white rounded-lg shadow-sm mb-2 transition hover:bg-red-50",n.innerHTML=`
                    <span class="text-gray-800 font-medium">${r.name}</span>
                    <button data-id="${r.id}" class="delete-player-btn text-red-500 hover:text-red-700 p-1 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                            <path d="M3 6h18"/>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        </svg>
                    </button>
                `,e.appendChild(n)}),document.querySelectorAll(".delete-player-btn").forEach(r=>{r.addEventListener("click",n=>{const s=n.currentTarget.getAttribute("data-id");I(s)})}),C()}function P(e){const r=e.matchId;let n=document.getElementById(`match-row-${r}`);const s=!n;s&&(n=document.createElement("div"),n.id=`match-row-${r}`,n.className="bg-white p-4 rounded-xl shadow-md mb-4 flex flex-col md:flex-row items-center justify-between border border-gray-100");const t=e.teamA.join(" & "),o=e.teamB.join(" & ");let a="",c="";e.scoreA!==null&&e.scoreB!==null&&e.scoreA!==e.scoreB&&(e.scoreA>e.scoreB?a="font-bold text-green-700 bg-green-100 px-2 py-1 rounded":c="font-bold text-green-700 bg-green-100 px-2 py-1 rounded");const u=e.scoreA!==null?e.scoreA:"",i=e.scoreB!==null?e.scoreB:"";n.innerHTML=`
                <div class="w-full md:w-3/5 mb-3 md:mb-0">
                    <h4 class="text-lg font-semibold text-gray-800 mb-1">Match ${r}</h4>
                    <p class="${a}">Team A: ${t}</p>
                    <p class="${c}">Team B: ${o}</p>
                </div>
                <div class="w-full md:w-2/5 flex items-center space-x-2">
                    <input type="number" id="score-a-${r}" value="${u}" min="0" onchange="recordScore(${r})" class="w-1/4 p-2 border border-gray-300 rounded-lg text-center focus:border-indigo-500" placeholder="A Score">
                    <span class="text-xl font-bold text-gray-500">-</span>
                    <input type="number" id="score-b-${r}" value="${i}" min="0" onchange="recordScore(${r})" class="w-1/4 p-2 border border-gray-300 rounded-lg text-center focus:border-indigo-500" placeholder="B Score">
                    <button onclick="recordScore(${r})" class="w-2/4 bg-indigo-600 text-white p-2 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 shadow-md">Update Score</button>
                </div>
            `,s&&document.getElementById("schedule-container").appendChild(n)}function M(){const e=document.getElementById("schedule-container");e.innerHTML="",window.appState.schedule.length===0&&(e.innerHTML='<p class="text-gray-500 italic">Generate a schedule to see the matches.</p>'),window.appState.schedule.forEach(r=>{P(r)})}function L(){const e=document.getElementById("standings-container"),{standings:r}=window.appState,n=Object.entries(r).map(([a,c])=>({name:a,...c})).sort((a,c)=>c.average!==a.average?c.average-a.average:c.score-a.score),s=n.some(a=>a.score>0);if(n.length===0||!s){e.innerHTML='<p class="text-gray-500 italic">Enter match scores to calculate the standings.</p>';return}const t=n.length>0?n[0].name:"",o=n.length>0?n[0].average.toFixed(2):0;e.innerHTML=`
                <div class="text-center mb-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg shadow-inner">
                    <h3 class="text-xl font-bold text-yellow-700">Daily Winner: ${t} (Avg. ${o} pts/match)</h3>
                </div>
                <div class="flex justify-between items-center px-3 pb-2 border-b border-gray-200">
                    <span class="text-sm font-semibold text-gray-500">Player</span>
                    <span class="text-sm font-semibold text-gray-500 text-right">Score (Matches | Avg)</span>
                </div>
                <ul class="space-y-2">
                    ${n.map((a,c)=>{const u=`${a.score} total (${a.matches} | ${a.average.toFixed(2)})`,i=c===0;return`
                            <li class="flex justify-between items-center p-3 rounded-lg shadow-sm ${i?"bg-yellow-50 border-yellow-500 border-l-4":"bg-gray-50"}">
                                <span class="text-lg ${i?"font-extrabold text-yellow-800":"font-medium text-gray-700"}">${c+1}. ${a.name}</span>
                                <span class="${i?"font-bold text-lg text-yellow-800":"text-md font-semibold text-gray-800"} text-right">${u}</span>
                            </li>
                        `}).join("")}
                </ul>
            `}window.onload=function(){V(),document.getElementById("add-player-form").addEventListener("submit",e=>{e.preventDefault();const r=document.getElementById("new-player-name"),n=r.value.trim();n?(U(n),r.value=""):(window.appState.error="Player name cannot be empty.",p())}),document.getElementById("num-matches").addEventListener("change",e=>{const r=parseInt(e.target.value,10);window.appState.numMatches=r>0?r:1,e.target.value=window.appState.numMatches}),M(),L(),C()};window.recordScore=recordScore;window.generateSchedule=generateSchedule;window.deletePlayer=I;window.shareSchedule=shareSchedule;
